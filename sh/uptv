#!/bin/sh

usage () {
 echo "Usage: $(basename "$0") [ch|ck|m3u]"
 echo "Scrape and list U+TV channels"
}

[ -z "$1" ] && usage && exit

time=$(date +%Y%m%d%H%M%S)
m3u_dir="/home/parkmino/Videos"

ch_1=747; prog_1="JTBC"
ch_2=750; prog_2="MBN"
ch_3=749; prog_3="채널A"
ch_4=746; prog_4="TV조선"
ch_5=596; prog_5="OBS"
ch_6=772; prog_6="더라이프"
ch_7=606; prog_7="JTBC2"
ch_8=662; prog_8="K스타"
ch_9=603; prog_9="라이프타임"
ch_10=767; prog_10="JTBC4"
ch_11=658; prog_11="아시아N"
ch_12=794; prog_12="가요TV"
ch_13=688; prog_13="GMTV"
ch_14=382; prog_16="EBS1"
ch_15=602; prog_17="JTBC골프"
ch_16=614; prog_18="SBS골프"
ch_17=795; prog_19="JTBC골프앤스포츠"
ch_18=668; prog_20="빌리어즈TV"
ch_19=729; prog_21="CNN International"
ch_20=771; prog_22="토마토증권통"
ch_21=174; prog_23="CNBC"
ch_22=676; prog_24="GS샵"
ch_23=675; prog_25="현대홈쇼핑"
ch_24=672; prog_26="CJ온스타일"
ch_25=674; prog_27="롯데홈쇼핑"
ch_26=673; prog_28="NS홈쇼핑"
ch_27=649; prog_29="홈앤쇼핑"
ch_28=740; prog_30="GS마이샵"
ch_29=760; prog_31="현대홈쇼핑+샵"
ch_30=813; prog_32="W쇼핑"
ch_31=391; prog_33="PLAYY프리미엄"
ch_32=392; prog_34="PLAYY웰메이드"
ch_33=683; prog_35="바둑TV"
ch_34=665; prog_36="FTV"
ch_35=625; prog_37="한국낚시방송"
ch_36=726; prog_38="폴라리스TV"
ch_37=707; prog_39="브레인TV"
ch_38=703; prog_40="애니맥스"
ch_39=699; prog_41="애니플러스"
ch_40=761; prog_42="어린이TV"
ch_41=728; prog_43="브라보키즈"
ch_42=629; prog_44="플레이보이"
ch_43=628; prog_45="미드나잇"
ch_44=743; prog_46="허니TV"
ch_45=751; prog_47="비키"
ch_46=165; prog_48="핑크하우스"
ch_47=166; prog_49="디자이어TV"
ch_48=801; prog_50="비너스TV"

uptv_ck () {
 ch="http://123.140.104.150/api/epg/v1/channel/virtual?access_key=C4A0697007C3548D389B&cp_id=S_LGU_HYUK0920&system_id=HDTV&SA_ID=500053434041&STB_MAC=v000.5343.4041&NSC_TYPE=LTE&BASE_GB=Y&BASE_CD=W172.017&YOUTH_YN=N&ORDER_GB=N&POOQ_YN=N&HDTV_VIEW_GB=R&SID=001010005638&CLIENT_IP=172.17.100.15&OS_INFO=android_4.4.2&NW_INFO=WIFI&APP_TYPE=ROSA&DEV_MODEL=SM-N935F&CARRIER_TYPE=E&UI_VER=04.38.04&NOW_PAGE=25&PRE_PAGE=&MENU_NM=&CONTS_GB=&TERM_BINVER=3.8.118.0106"
 times=$(curl -s "$ch" | grep -o "<service_id>" | wc -l)
 for i in $(seq 1 $times); do
  echo "ch_$i=$(curl -s "$ch" | grep -o "<service_id>[0-9]*" | cut -d\> -f2 | head -$i | tail -1); prog_$i=\"$(curl -s "$ch" | grep -o "<service_name>...................." | cut -d\> -f2 | cut -d\< -f1 | sed 's/^[ \t]//' | head -$i | tail -1)\""
 done
 echo
 for i in $(seq 1 $times); do
  printf "($i) $(curl -s "$ch" | grep -o "<service_name>...................." | cut -d\> -f2 | cut -d\< -f1 | sed 's/^[ \t]//' | head -$i | tail -1)"
  [ $(expr $i % 5) -eq 0 ] && printf '\n' || printf '\t'
 done
 [ $(expr $i % 5) -eq 0 ] || printf '\n'
}

uptv_m3u () {
 nr=1
 printf "#EXTM3U\n" > $m3u_dir/uptv.m3u
 while true; do
  ch=$(eval echo \$ch_$nr)
  [ -z "$ch" ] && break
 #url="http://1.214.67.74:80/${ch}HN.m3u8?VOD_RequestID=v2M2-0101-1010-7272-5050-0000$time;LTE;720p;WIFI&APPNAME=hdtv&ALBUM_ID=747&ma=D0:17:C2:CE:D7:A1"
  url="http://1.214.67.74:80/${ch}HN.m3u8?VOD_RequestID=v2M2-0101-1010-7272-5050-0000$time"
  printf "#EXTINF:-1,$(eval echo \$prog_$nr)\n$url\n" >> $m3u_dir/uptv.m3u
  nr=$(($nr+1))
 done
}

uptv_ch () {
 echo "\
(1)  JTBC	(2)  MBN	(3)  채널A	(4)  TV조선	(5)  OBS
(6)  더라이프	(7)  JTBC2	(8)  K스타	(9)  라이프타.	(10) JTBC4
(11) 아시아N	(12) 가요TV	(13) GMTV       (14) EBS1	(15) JTBC골프
(16) SBS골프	(17) SBS스포츠	(18) 빌리어즈	(19) CNN	(20) 토마토증권
(21) CNBC	(22) GS샵	(23) 현대홈	(24) CJ온스타	(25) 롯데홈쇼핑
(26) NS홈쇼핑	(27) 홈앤쇼핑	(28) GS마이샵	(29) 현대홈+샵	(30) W 쇼핑
(31) PLAYY프.	(32) PLAYY웰.	(33) 바둑TV	(34) FTV	(35) 피싱TV
(36) 폴라리스	(37) 브레인TV	(38) 애니맥스	(39) 애니+	(40) 어린이TV
(41) 브라보키	(42) 플레이보.	(43) 미드나잇	(44) 허니TV"

 read -p " " i

 ch=$(eval echo \$ch_$i)
 [ -z "$ch" ] && exit
#url="http://1.214.67.74:80/${ch}HN.m3u8?VOD_RequestID=v2M2-0101-1010-7272-5050-0000$time;LTE;720p;WIFI&APPNAME=hdtv&ALBUM_ID=747&ma=D0:17:C2:CE:D7:A1"
 url="http://1.214.67.74:80/${ch}HN.m3u8?VOD_RequestID=v2M2-0101-1010-7272-5050-0000$time"
 prog=$(eval echo \$prog_$i)
 [ -z "$prog" ] && prog=$i
 echo " $prog"
 echo " $url"
 printf "#EXTM3U\n#EXTINF:-1,$prog\n$url\n" > $m3u_dir/$prog.m3u
}

case "$1" in
 ch)	uptv_ch  ;;
 ck)	uptv_ck  ;;
 m3u)	uptv_m3u ;;
 *)	usage    ;;
esac
